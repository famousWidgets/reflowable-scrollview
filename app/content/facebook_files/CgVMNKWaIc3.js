/*!CK:1761936070!*//*1399921295,178158661*/

if (self.CavalryLogger) { CavalryLogger.start_js(["fll7u"]); }

__d("MercuryActionStatus",[],function(a,b,c,d,e,f){e.exports={UNSENT:0,SUCCESS:1,UNCONFIRMED:3,FAILED_UNKNOWN_REASON:4,UNABLE_TO_CONFIRM:5,RESENT:6,RESENDING:7,ERROR:10};});
__d("MercuryActionTypeConstants",[],function(a,b,c,d,e,f){e.exports={LOG_MESSAGE:"ma-type:log-message",USER_GENERATED_MESSAGE:"ma-type:user-generated-message",CHANGE_READ_STATUS:"ma-type:change_read_status",CHANGE_MUTE_SETTINGS:"ma-type:change-mute-settings",CLEAR_CHAT:"ma-type:clear_chat",SEND_MESSAGE:"ma-type:send-message",UPDATE_ACTION_ID:"ma-type:update-action-id",DELETE_MESSAGES:"ma-type:delete-messages",DELETE_THREAD:"ma-type:delete-thread",CHANGE_ARCHIVED_STATUS:"ma-type:change-archived-status",CHANGE_FOLDER:"ma-type:change-folder"};});
__d("MercuryAPIArgsSource",[],function(a,b,c,d,e,f){e.exports={CHAT:"chat",JEWEL:"jewel",MERCURY:"mercury",WEBMESSENGER:"web_messenger"};});
__d("MercuryAttachmentContentType",[],function(a,b,c,d,e,f){e.exports={PHOTO:"attach:image",VIDEO:"attach:video",MUSIC:"attach:music",VOICE:"attach:voice",TEXT:"attach:text",MSWORD:"attach:ms:word",MSXLS:"attach:ms:xls",MSPPT:"attach:ms:ppt",UNKNOWN:"attach:unknown"};});
__d("MercuryAttachmentType",[],function(a,b,c,d,e,f){e.exports={ERROR:"error",FILE:"file",PHOTO:"photo",STICKER:"sticker",SHARE:"share",VIDEO:"video"};});
__d("MercuryErrorType",[],function(a,b,c,d,e,f){e.exports={SERVER:1,TRANSPORT:2,TIMEOUT:3};});
__d("MercuryGenericConstants",[],function(a,b,c,d,e,f){e.exports={PENDING_THREAD_ID:"pending:pending",MAX_THREAD_NAME_LENGTH:"250"};});
__d("MercuryGlobalActionType",[],function(a,b,c,d,e,f){e.exports={MARK_ALL_READ:"mga-type:mark-all-read"};});
__d("MercuryLogMessageType",[],function(a,b,c,d,e,f){e.exports={SUBSCRIBE:"log:subscribe",UNSUBSCRIBE:"log:unsubscribe",VIDEO_CALL:"log:video-call",PHONE_CALL:"log:phone-call",THREAD_NAME:"log:thread-name",THREAD_IMAGE:"log:thread-image",SERVER_ERROR:"log:error-msg",LIVE_LISTEN:"log:live-listen",WALLPAPER:"log:wallpaper"};});
__d("MercuryParticipantTypes",[],function(a,b,c,d,e,f){e.exports={USER:"user",THREAD:"thread",EVENT:"event",PAGE:"page",FRIEND:"friend"};});
__d("MercuryPayloadSource",[],function(a,b,c,d,e,f){e.exports={UNKNOWN:"unknown",CLIENT_CHANNEL_MESSAGE:"client_channel_message",CLIENT_SAVE_DRAFT:"client_save_draft",CLIENT_SEND_MESSAGE:"client_send_message",CLIENT_CHANGE_ARCHIVED_STATUS:"client_change-archived_status",CLIENT_CHANGE_FOLDER:"client_change_folder",CLIENT_CHANGE_MUTE_SETTINGS:"client_change_mute_settings",CLIENT_CHANGE_READ_STATUS:"client_change_read_status",CLIENT_CLEAR_CHAT:"client_clear_chat",CLIENT_DELETE_MESSAGES:"client_delete_messages",CLIENT_DELETE_THREAD:"client_delete_thread",CLIENT_HANDLE_ERROR:"client_handle_error",SERVER_INITIAL_DATA:"server_initial_data",SERVER_SAVE_DRAFT:"server_save_draft",SERVER_SEND_MESSAGE:"server_send_message",SERVER_CONFIRM_MESSAGES:"server_confirm_messages",SERVER_CHANGE_ARCHIVED_STATUS:"server_change_archived_status",SERVER_CHANGE_READ_STATUS:"server_change_read_status",SERVER_MARK_FOLDER_READ:"server_mark_folder_read",SERVER_MARK_SEEN:"server_mark_seen",SERVER_FETCH_THREAD_INFO:"server_fetch_thread_info",SERVER_FETCH_THREADLIST_INFO:"server_fetch_threadlist_info",SERVER_THREAD_SYNC:"server_thread_sync",SERVER_TAB_PRESENCE:"server_tab_presence",SERVER_UNREAD_THREADS:"server_unread_threads",SERVER_SEARCH:"server_search"};});
__d("MercurySourceType",[],function(a,b,c,d,e,f){e.exports={CHAT_ORCA:"source:chat:orca",CHAT_IPHONE:"source:chat:iphone",CHAT_JABBER:"source:chat:jabber",CHAT_MEEBO:"source:chat:meebo",CHAT_WEB:"source:chat:web",CHAT_TEST:"source:chat:test",CHAT:"source:chat",EMAIL:"source:email",GIGABOXX_API:"source:gigaboxx:api",GIGABOXX_BLAST:"source:gigaboxx:blast",GIGABOXX_EMAIL_REPLY:"source:gigaboxx:emailreply",GIGABOXX_MOBILE:"source:gigaboxx:mobile",GIGABOXX_WAP:"source:gigaboxx:wap",GIGABOXX_WEB:"source:gigaboxx:web",LEIA:"source:leia",SHARE_DIALOG:"source:share:dialog",SEND_PLUGIN:"source:sendplugin",SMS:"source:sms",TEST:"source:test",TITAN_WAP:"source:titan:wap",TITAN_M_BASIC:"source:titan:m_basic",TITAN_M_JAPAN:"source:titan:m_japan",TITAN_M_MINI:"source:titan:m_mini",TITAN_M_TOUCH:"source:titan:m_touch",TITAN_M_APP:"source:titan:m_app",TITAN_M_TABLET:"source:titan:m_tablet",TITAN_M_ZERO:"source:titan:m_zero",TITAN_M_TALK:"source:titan:m_talk",TITAN_WEB:"source:titan:web",TITAN_FACEWEB_ANDROID:"source:titan:faceweb_android",TITAN_FACEWEB_BUFFY:"source:titan:faceweb_buffy",TITAN_FACEWEB_IPAD:"source:titan:faceweb_ipad",TITAN_FACEWEB_IPHONE:"source:titan:faceweb_iphone",TITAN_FACEWEB_UNKNOWN:"source:titan:faceweb_unknown",TITAN_API:"source:titan:api",TITAN_API_MOBILE:"source:titan:api_mobile",TITAN_ORCA:"source:titan:orca",TITAN_EMAIL_REPLY:"source:titan:emailreply",MOBILE:"source:mobile",UNKNOWN:"source:unknown",WEB:"source:web",HELPCENTER:"source:helpcenter",NEW_SHARE_DIALOG:"source:share:dialog:new",PAID_PROMOTION:"source:paid_promotion",BUFFY_SMS:"source:buffy:sms",WEBRTC_MOBILE:"source:webrtc:mobile"};});
__d("MercuryThreadMode",[],function(a,b,c,d,e,f){e.exports={EMAIL_ORIGINATED:1,TITAN_ORIGINATED:2,OBJECT_ORIGINATED:3};});
__d("MessagingTag",[],function(a,b,c,d,e,f){e.exports={GROUPS:"groups",UNREAD:"unread",ACTION_ARCHIVED:"action:archived",INBOX:"inbox",OTHER:"other",EVENT:"event",SENT:"sent",SMS_MUTE:"sms_mute",SPAM:"spam",UPDATES:"broadcasts_inbox",BCC:"header:bcc",FILTERED_CONTENT:"filtered_content",ARCHIVED:"archived",EMAIL:"email",VOICEMAIL:"voicemail",SPAM_SPOOFING:"spam:spoofing",SPOOF_WARNING:"MTA:spoof_warning",SMS_TAG_ROOT:"SMSShortcode:",APP_ID_ROOT:"app_id:",DOMAIN_AUTH_PASS:"MTA:dmarc:pass",DOMAIN_AUTH_FAIL:"MTA:dmarc:fail",MTA_SYSTEM_MESSAGE:"MTA:system_message",EMAIL_MESSAGE:"source:email"};});
__d("PhotoResizeModeConst",[],function(a,b,c,d,e,f){e.exports={CONTAIN:"s",COVER:"p"};});
__d("ReportState",["ErrorUtils","invariant"],function(a,b,c,d,e,f,g,h){var i={};function j(l,m){h(!i[l]);i[l]=m;}function k(){var l={};Object.keys(i).forEach(function(m){try{l[m]=i[m]();}catch(n){g.reportError('ReportState: callback threw an error.');}});return l;}e.exports={registerCallback:j,getState:k};});
__d("PresenceUtil",["Cookie","CurrentUser","randomInt"],function(a,b,c,d,e,f,g,h,i){var j=i(0,4294967295)+1;function k(){return j;}function l(){return h.getID()===g.get('c_user');}e.exports={getSessionID:k,hasUserCookie:l};});
__d("MercurySingletonMixin",["CurrentUser"],function(a,b,c,d,e,f,g){var h={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.getID());},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=h;});
__d("MercuryMessageClientState",[],function(a,b,c,d,e,f){var g={DO_NOT_SEND_TO_SERVER:'do_not_send_to_server',SEND_TO_SERVER:'send_to_server'};e.exports=g;});
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f,g){var h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;});
__d("ImageSourceType",[],function(a,b,c,d,e,f){var g={PROFILE_PICTURE:'profile_picture',IMAGE:'image'};e.exports=g;});
__d("ImageSourceRequest",["CurrentUser","ImageSourceType","KeyedCallbackManager","PhotoResizeModeConst","MercuryServerDispatcher","arrayContains","extendArray"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){"use strict";this._request={fbid:null,type:null,width:null,height:null,resize_mode:null};this._callback=null;}n.prototype.setFBID=function(r){"use strict";this._request.fbid=r;return this;};n.prototype.setType=function(r){"use strict";if(!l([h.PROFILE_PICTURE,h.IMAGE],r))throw new TypeError('ImageSourceRequest.setType: invalid type '+r);this._request.type=r;return this;};n.prototype.setDimensions=function(r,s){"use strict";this._request.width=r;this._request.height=s;return this;};n.prototype.setResizeMode=function(r){"use strict";if(!l([j.COVER,j.CONTAIN],r))throw new TypeError('ImageSourceRequest.setResizeMode: invalid resize mode '+r);this._request.resize_mode=r;return this;};n.prototype.setCallback=function(r){"use strict";this._callback=r;return this;};n.prototype.send=function(){"use strict";if(!this._request.fbid||!this._request.width||!this._request.height||!this._request.type||!this._request.resize_mode||!this._callback)throw new Error('ImageSourceRequest: You must set all the fields');var r=p(),s=q(this._request);r.executeOrEnqueue(s,this._callback);if(r.getUnavailableResourcesFromRequest(s).length===1){k.trySend('/ajax/image_source.php',{requests:[this._request]});return true;}return false;};var o=null;function p(){if(o)return o;var r=new i();o=r;k.registerEndpoints({'/ajax/image_source.php':{request_user_id:g.getID(),mode:k.BATCH_DEFERRED_MULTI,batch_function:function(s,t){m(s.requests,t.requests);return s;},handler:function(s,t){var u=t.getData().requests;for(var v=0;v<u.length;++v)r.setResource(q(u[v]),s[v]);}}});return r;}function q(r){return [r.fbid,r.type,r.width,r.height,r.resize_mode].join('|');}e.exports=n;});
__d("MercuryIDs",[],function(a,b,c,d,e,f){function g(i){return typeof i==='string'&&i.indexOf(':')!==-1;}var h={isValid:function(i){if(!i)return false;return g(i);},isValidThreadID:function(i){if(!h.isValid(i))return false;var j=h.tokenize(i);switch(j.type){case 'user':case 'group':case 'thread':case 'root':case 'pending':return true;default:return false;}},tokenize:function(i){if(!this.isValid(i))throw 'bad_id_format';var j=i.indexOf(':');return {type:i.substr(0,j),value:i.substr(j+1)};},getUserIDFromParticipantID:function(i){if(!h.isValid(i))return null;var j=h.tokenize(i);if(j.type!='fbid')return null;return j.value;},isMultichat:function(i){return this.isValid(i)&&this.tokenize(i).type!=='user';}};e.exports=h;});
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f,g){e.exports={isParticipantID:function(h){if(!g.isValid(h))throw ("bad_participant_id "+h);},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw ("bad_user_id "+h);},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw ("bad_email_id "+h);},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw ("bad_thread_id "+h);}};});
__d("TimestampConverter",["JSLogger"],function(a,b,c,d,e,f,g){var h=g.create('timestamp_converter');function i(k){return (typeof(k)=='string')&&k.length>6;}var j={convertActionIDToTimestamp:function(k){if(i(k)){var l=k.slice(0,-6);return parseInt(l,10);}},maxValidActionID:function(k,l){if(!i(k))return l;if(!i(l))return k;return this.isGreaterThan(k,l)?k:l;},isGreaterThan:function(k,l){if(!i(k)||!i(l))return false;return this.convertActionIDToTimestamp(k)>this.convertActionIDToTimestamp(l);}};e.exports=j;});
__d("XMercurySendLogControllerURIBuilder",["XControllerURIBuilder"],function(a,b,c,d,e,f,g){e.exports=g.create("\/messaging\/send_logger\/",{message_id:{type:"String",required:true},event:{type:"Enum",required:true},is_canonical:{type:"Bool"}});});
__d("MercurySendLogger",["AsyncSignal","XMercurySendLogControllerURIBuilder"],function(a,b,c,d,e,f,g,h){var i=false,j={CLIENT_SEND_ATTEMPTED:'client_send_attempted',CLIENT_RESEND_ATTEMPTED:'client_resend_attempted',CLIENT_SEND_SUCCEEDED:'client_send_succeeded',CLIENT_SEND_FAILED:'client_send_failed',CLIENT_CHANNEL_ECHO:'client_channel_echo',enable:function(){i=true;},log:function(event,k,l){if(!i)return;new g((new h()).setEnum('event',event).setString('message_id',k).setBool('is_canonical',!!l.canonical).getURI().toString()).send();}};e.exports=j;});
__d("MessagingReliabilityLogger",["PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k){var l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==undefined){var da=ba[ca];if(da!==undefined)p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==undefined)p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;});
__d("MercuryThreadInformer",["ArbiterMixin","copyProperties","MercuryAssert","MercurySingletonMixin"],function(a,b,c,d,e,f,g,h,i,j){function k(m){if(!m._locked){var n=m._threadDeletions,o=m._threadChanges,p=m._threadReadChanges,q=m._threadlistChanged,r=m._unseenStateChanged,s=m._unreadStateChanged,t=m._receivedMessages,u=m._reorderedMessages,v=m._updatedMessages;m._threadDeletions={};m._threadChanges={};m._threadReadChanges={};m._threadlistChanged=false;m._unseenStateChanged=false;m._unreadStateChanged=false;m._receivedMessages={};m._reorderedMessages={};m._updatedMessages={};var w=Object.keys(o);if(w.length||q)m.inform('threadlist-updated',w);if(w.length)m.inform('threads-updated',o);for(var x in p){m.inform('thread-read-changed',p);break;}for(var x in n){m.inform('threads-deleted',n);break;}if(r)m.inform('unseen-updated',null);if(s)m.inform('unread-updated',null);for(x in t){m.inform('messages-received',t);break;}for(x in u){m.inform('messages-reordered',u);break;}for(x in v){m.inform('messages-updated',v);break;}}}function l(m){this._fbid=m;this._threadDeletions={};this._threadChanges={};this._threadReadChanges={};this._threadlistChanged=false;this._unseenStateChanged=false;this._unreadStateChanged=false;this._receivedMessages={};this._reorderedMessages={};this._updatedMessages={};this._locked=0;}h(l.prototype,g,{updatedThread:function(m){this._threadChanges[m]=true;k(this);},deletedThread:function(m){this._threadDeletions[m]=true;k(this);},updatedThreadlist:function(){this._threadlistChanged=true;k(this);},updatedUnseenState:function(){this._unseenStateChanged=true;k(this);},updatedUnreadState:function(){this._unreadStateChanged=true;k(this);},changedThreadReadState:function(m,n,o){if(!this._threadReadChanges[m]||this._threadReadChanges[m].timestamp<o)this._threadReadChanges[m]={mark_as_read:n,timestamp:o};k(this);},receivedMessage:function(m){i.isThreadID(m.thread_id);var n=m.thread_id;if(!this._receivedMessages[n])this._receivedMessages[n]=[];this._receivedMessages[n].push(m);this.updatedThread(n);},reorderedMessages:function(m,n){this._reorderedMessages[m]={source:n};k(this);},updatedMessage:function(m,n,o){if(!this._updatedMessages[m])this._updatedMessages[m]={};this._updatedMessages[m][n]={source:o};this.updatedThread(m);},synchronizeInforms:function(m){this._locked++;try{m();}catch(n){throw n;}finally{this._locked--;k(this);}},listen:function(m,n){return this.subscribe('threads-updated',function(o,p){if(p[m])n(m);});}});h(l,j);e.exports=l;});
__d("MercuryServerRequests",["ArbiterMixin","AsyncResponse","BanzaiLogger","TimestampConverter","CurrentUser","KeyedCallbackManager","LogHistory","MercuryActionStatus","MercuryActionTypeConstants","MercuryAPIArgsSource","MercuryAssert","MercuryErrorType","MercuryGenericConstants","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercuryMessageClientState","MercuryPayloadSource","MercurySendLogger","MercuryServerRequestsConfig","MercurySingletonMixin","MercurySourceType","MercuryThreadlistConstants","MercuryMessageIDs","MessagingConfig","MessagingReliabilityLogger","MessagingTag","MercuryServerDispatcher","MercuryThreadInformer","copyProperties","createObjectFrom","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la){"use strict";var ma=m.getInstance('mercury_server'),na=p.MERCURY;function oa(xb,yb){if(yb)xb._lastActionId=j.maxValidActionID(xb._lastActionId,yb);}function pa(xb,yb){var zb=yb.thread_id,ac=xb._serverToClientIDs.getResource(zb);if(!ac){if(yb.canonical_fbid){ac='user:'+yb.canonical_fbid;}else if(yb.root_message_threading_id)ac='root:'+yb.root_message_threading_id;ac=ac||'thread:'+zb;qa(xb,zb,ac);}yb.thread_id=ac;}function qa(xb,yb,zb){xb._serverToClientIDs.setResource(yb,zb);xb._clientToServerIDs.setResource(zb,yb);xb._newlyAddedClientIDs[yb]=zb;}function ra(xb,yb,zb){var ac=xb._clientToServerIDs.executeOrEnqueue(yb,zb),bc=xb._clientToServerIDs.getUnavailableResources(ac),cc=xb.tokenizeThreadID(yb);if(bc.length&&cc.type!='root')xb.fetchThreadData(bc);}function sa(xb,yb){return xb._clientToServerIDs.getResource(yb);}function ta(xb,yb){return !!xb._serverToClientIDs.getResource(yb);}function ua(xb,yb){var zb=xb._serverToClientIDs.getResource(yb);if(typeof zb=='undefined')ma.warn('no_client_thread_id',{server_id:yb});return zb;}function va(xb,yb,zb){xb._serverToClientIDs.executeOrEnqueue(yb,zb);xb.ensureThreadIsFetched(yb);}function wa(xb,yb,zb){if(yb.action_type!=o.SEND_MESSAGE)return;var ac=yb.client_thread_id;if(!ac)ac=ua(xb,yb.thread_id);var bc=null;if(ac)bc=u.tokenize(ac).type;fa.addEntry('send_'+bc,zb,yb.thread_id+','+yb.message_id);y.log(zb==='success'?y.CLIENT_SEND_SUCCEEDED:y.CLIENT_SEND_FAILED,yb.client_message_id,{canonical:bc&&!u.isMultichat(ac)});}function xa(xb){return xb.getError()?'_'+xb.getError():'';}function ya(xb,yb){if(yb.client_message_id in xb._sentMessagesTimestamp){var zb=xb._sentMessagesTimestamp[yb.client_message_id],ac=Date.now()-zb,bc=yb.client_thread_id;if(!bc)bc=ua(xb,yb.thread_id);i.log('WebMessagingLatencyLoggerConfig',{has_attachment:(yb.attachments.length>0),latency:ac,is_canonical:!u.isMultichat(bc),source:'client'});}}function za(xb,yb){var zb=null;switch(yb.status){case n.SUCCESS:if(Math.floor(Math.random()*10)===0)ya(xb,yb);zb='success';break;case n.FAILED_UNKNOWN_REASON:zb='confirmed_error';break;case n.UNABLE_TO_CONFIRM:zb='confirm_error';break;default:return;}wa(xb,yb,zb);}function ab(xb,yb){(yb.message_counts||[]).forEach(function(hc){oa(xb,hc.last_action_id);});(yb.threads||[]).forEach(function(hc){pa(xb,hc);delete xb._fetchingThreads[hc.thread_id];var ic=sa(xb,hc.thread_id);delete xb._fetchingThreads[ic];oa(xb,hc.last_action_id);});(yb.ordered_threadlists||[]).forEach(function(hc){hc.thread_ids=hc.thread_ids.map(ua.bind(null,xb));});yb.actions=yb.actions||[];yb.actions.forEach(function(hc){za(xb,hc);if(hc.status&&hc.status!=n.SUCCESS&&!hc.thread_id){hc.thread_id=hc.client_thread_id;return;}if(hc.action_type==o.SEND_MESSAGE&&hc.client_thread_id&&hc.client_thread_id!=s.PENDING_THREAD_ID&&hc.thread_id)qa(xb,hc.thread_id,hc.client_thread_id);hc.server_thread_id=hc.thread_id;if(hc.thread_id){hc.thread_id=ta(xb,hc.thread_id)?ua(xb,hc.thread_id):null;}else if(hc.client_thread_id)hc.thread_id=hc.client_thread_id;oa(xb,hc.action_id);});if(yb.end_of_history){var zb=[];for(var ac=0;ac<yb.end_of_history.length;ac++){var bc=yb.end_of_history[ac];if(bc.type=='user'){zb.push('user:'+bc.id);}else if(bc.type=='thread'&&ta(xb,bc.id))zb.push(ua(xb,bc.id));}yb.end_of_history=zb;}if(yb.roger){var cc={};for(var dc in yb.roger){var ec=xb._serverToClientIDs.getResource(dc);if(ec){var fc=yb.roger[dc];cc[ec]={};for(var gc in fc)cc[ec]['fbid:'+gc]=fc[gc];}}yb.roger=cc;}}function bb(xb){if(xb._pendingUpdates&&xb._pendingUpdates.length){var yb=xb._pendingUpdates[0];xb._pendingUpdates=xb._pendingUpdates.slice(1);xb.handleUpdate(yb);}}function cb(xb,yb){var zb=ja({},xb),ac;if(yb.threads){if(!zb.threads)zb.threads={};for(ac in yb.threads)zb.threads[ac]=Object.keys(ka((zb.threads[ac]||[]).concat(yb.threads[ac])));}if(yb.messages){if(!zb.messages)zb.messages={};for(ac in yb.messages){if(!zb.messages[ac])zb.messages[ac]={};for(var bc in yb.messages[ac])if(zb.messages[ac][bc]){zb.messages[ac][bc]=fb(zb.messages[ac][bc],yb.messages[ac][bc]);}else zb.messages[ac][bc]=yb.messages[ac][bc];}}zb.client=xb.client||yb.client;return zb;}function db(xb,yb){var zb=ja(ka(xb.folders,true),ka(yb.folders,true)),ac=xb.client||yb.client;return {folders:Object.keys(zb),client:ac};}function eb(xb,yb){for(var zb in yb)if(xb[zb]&&typeof xb[zb]==='object'){xb[zb]=fb(xb[zb],yb[zb]);}else if(yb[zb]&&typeof yb[zb]==='object'){var ac={};ja(ac,yb[zb]);xb[zb]=ac;}return xb;}function fb(xb,yb){var zb=xb.offset<yb.offset?xb.offset:yb.offset,ac=xb.offset+xb.limit,bc=yb.offset+yb.limit,cc=(ac>bc)?ac:bc,dc=cc-zb;return {offset:zb,limit:dc};}function gb(xb,yb){var zb=xb.client||yb.client,ac={ids:{},client:zb};ja(ac.ids,xb.ids);ja(ac.ids,yb.ids);return ac;}function hb(xb,yb){var zb={},ac,bc=xb.client||yb.client;delete xb.client;delete yb.client;for(ac in xb)ja(zb,ka(xb[ac],ac));for(ac in yb)ja(zb,ka(yb[ac],ac));var cc={client:bc};for(var dc in zb){ac=zb[dc];if(!cc[ac])cc[ac]=[];cc[ac].push(dc);}return cc;}function ib(xb,yb){var zb=xb.client||yb.client,ac=ka(xb.ids,true),bc=ka(yb.ids,true),cc=ja(ac,bc);return {ids:Object.keys(cc),client:zb};}function jb(xb){this._fbid=xb;this._lastActionId=0;this._serverToClientIDs=new l();this._clientToServerIDs=new l();this._pendingUpdates=[];this._fetchingThreads={};this._newlyAddedClientIDs={};this._sentMessagesTimestamp={};vb(this);}ja(jb.prototype,g,{tokenizeThreadID:function(xb){q.isThreadID(xb);return u.tokenize(xb);},getServerThreadID:function(xb,yb){q.isThreadID(xb);ra(this,xb,yb);},getClientThreadID:function(xb,yb){va(this,xb,yb);},getClientThreadIDNow:function(xb){return ua(this,xb);},getServerThreadIDNow:function(xb){return sa(this,xb);},convertThreadIDIfAvailable:function(xb){var yb=this._serverToClientIDs.getResource(xb);if(yb===undefined){return xb;}else return yb;},canLinkExternally:function(xb){q.isThreadID(xb);var yb=this.tokenizeThreadID(xb);return (yb.type=='user')||!!sa(this,xb);},fetchThreadlistInfo:function(xb,yb,zb,ac,bc){zb=zb||ga.INBOX;bc=bc||na;var cc=ac?ha.IMMEDIATE:null,dc={client:bc};dc[zb]={offset:xb,limit:yb,filter:ac};wb(this,'/ajax/mercury/threadlist_info.php',dc,cc);},fetchUnseenThreadIDs:function(xb,yb){yb=yb||na;this.fetchThreadlistInfo(ca.RECENT_THREAD_OFFSET,ca.JEWEL_THREAD_COUNT,xb,null,yb);},fetchUnreadThreadIDs:function(xb,yb){yb=yb||na;wb(this,'/ajax/mercury/unread_threads.php',{folders:[xb],client:yb});},fetchMissedMessages:function(xb,yb){yb=yb||na;wb(this,'/ajax/mercury/thread_sync.php',{last_action_id:this._lastActionId,folders:xb,client:yb});},fetchThreadData:function(xb,yb){yb=yb||na;q.allThreadID(xb);var zb={threads:{},client:yb},ac=[],bc=[];xb.forEach(function(dc){if(this._fetchingThreads[dc])return;this._fetchingThreads[dc]=true;var ec=sa(this,dc);if(ec){bc.push(ec);zb.threads.thread_ids=bc;}else{var fc=this.tokenizeThreadID(dc);if(fc.type=='user'){ac.push(fc.value);zb.threads.user_ids=ac;}else if(fc.type=='thread'){bc.push(fc.value);zb.threads.thread_ids=bc;}else if(fc.type!='root'&&fc.type!='pending')throw new Error('Unknown thread type',fc);}}.bind(this));this.inform("fetch-thread-data",zb);for(var cc in zb.threads){wb(this,'/ajax/mercury/thread_info.php',zb);break;}},ensureThreadIsFetched:function(xb,yb){yb=yb||na;if(!this._serverToClientIDs.getResource(xb)&&!this._fetchingThreads[xb]){this._fetchingThreads[xb]=true;wb(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[xb]},client:yb});}},fetchThreadMessages:function(xb,yb,zb,ac,bc){q.isThreadID(xb);bc=bc||na;var cc,dc,ec=this.tokenizeThreadID(xb),fc=sa(this,xb),gc=false;if(fc&&ec.type!='group'){dc='thread_ids';cc=fc;}else{cc=ec.value;switch(ec.type){case 'user':dc='user_ids';gc=true;break;case 'group':dc='group_ids';break;case 'thread':dc='thread_ids';break;}}var hc={messages:{},threads:{},client:bc};if(dc){hc.messages[dc]={};hc.messages[dc][cc]={offset:yb,limit:zb};if(gc)hc.threads[dc]=[cc];wb(this,'/ajax/mercury/thread_info.php',hc,ac);}else ra(this,xb,function(ic){hc.messages.thread_ids={};hc.messages.thread_ids[ic]={offset:yb,limit:zb};wb(this,'/ajax/mercury/thread_info.php',hc,ac);}.bind(this));},handleThreadInfoError:function(xb){var yb=xb.getRequest().getData(),zb=[];if(yb.messages){for(var ac in yb.messages.thread_ids)zb.push(kb(ua(this,ac)));for(var bc in yb.messages.user_ids)zb.push(kb('user:'+bc));for(var cc in yb.messages.group_ids)zb.push(kb('group:'+cc));}if(zb.length)this.handleUpdate({actions:zb,from_client:true,payload_source:x.CLIENT_CHANNEL_MESSAGE});if(yb.threads&&(yb.threads.user_ids||yb.threads.group_ids||yb.threads.thread_ids)){var dc=5,ec=true;if(!yb.retry_count){yb.retry_count=0;if(yb.messages)delete yb.messages;}else if(yb.retry_count>=dc){ec=false;(yb.threads.thread_ids||[]).forEach(function(gc){if(gc in this._fetchingThreads)delete this._fetchingThreads[gc];}.bind(this));}if(ec){var fc=yb.retry_count*1000;la(function(){ma.log('retry_thread',yb);wb(this,'/ajax/mercury/thread_info.php',yb);}.bind(this),fc);yb.retry_count++;}}},markFolderAsRead:function(xb){wb(this,'/ajax/mercury/mark_folder_as_read.php',{folder:xb});var yb=[{action_type:t.MARK_ALL_READ,action_id:null,folder:xb}];this.handleUpdate({global_actions:yb,from_client:true,payload_source:x.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(xb,yb,zb){q.isThreadID(xb);ra(this,xb,function(bc){var cc={ids:{}};cc.ids[bc]=yb;wb(this,'/ajax/mercury/change_read_status.php',cc);}.bind(this));var ac=[{action_type:o.CHANGE_READ_STATUS,action_id:null,thread_id:xb,mark_as_read:yb,folder:zb}];this.handleUpdate({actions:ac,from_client:true,payload_source:x.CLIENT_CHANGE_READ_STATUS});},changeThreadArchivedStatus:function(xb,yb){q.isThreadID(xb);ra(this,xb,function(bc){var cc={ids:{}};cc.ids[bc]=yb;wb(this,'/ajax/mercury/change_archived_status.php',cc);}.bind(this));var zb={action_type:o.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:xb,archived:yb},ac={actions:[zb],from_client:true,payload_source:x.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(ac);},changeThreadFolder:function(xb,yb){q.isThreadID(xb);ra(this,xb,function(bc){var cc={};cc[yb]=[bc];wb(this,'/ajax/mercury/move_thread.php',cc);}.bind(this));var zb={action_type:o.CHANGE_FOLDER,action_id:null,thread_id:xb,new_folder:yb},ac={actions:[zb],from_client:true,payload_source:x.CLIENT_CHANGE_FOLDER};this.handleUpdate(ac);},changeMutingOnThread:function(xb,yb){q.isThreadID(xb);ra(this,xb,function(bc){wb(this,'/ajax/mercury/change_mute_thread.php',{thread_id:bc,mute_settings:yb,payload_source:na});}.bind(this));var zb={action_type:o.CHANGE_MUTE_SETTINGS,action_id:null,thread_id:xb,mute_settings:yb},ac={actions:[zb],from_client:true,payload_source:x.CLIENT_CHANGE_MUTE_SETTINGS};this.handleUpdate(ac);},markThreadSpam:function(xb){q.isThreadID(xb);ra(this,xb,function(ac){wb(this,'/ajax/mercury/mark_spam.php',{id:ac});}.bind(this));var yb={action_type:o.CHANGE_FOLDER,action_id:null,thread_id:xb,new_folder:ga.SPAM},zb={actions:[yb],from_client:true,payload_source:x.CLIENT_CHANGE_FOLDER};this.handleUpdate(zb);},markMessagesSpam:function(xb,yb){da.getServerIDs(yb||[],function(ac){wb(this,'/ajax/mercury/mark_spam_messages.php',{message_ids:ac});}.bind(this));var zb={action_type:o.DELETE_MESSAGES,action_id:null,thread_id:xb,message_ids:yb};this.handleUpdate({actions:[zb],from_client:true,payload_source:x.CLIENT_DELETE_MESSAGES});},unmarkThreadSpam:function(xb){q.isThreadID(xb);ra(this,xb,function(ac){wb(this,'/ajax/mercury/unmark_spam.php',{id:ac});}.bind(this));var yb={action_type:o.CHANGE_FOLDER,action_id:null,thread_id:xb,new_folder:ga.INBOX},zb={actions:[yb],from_client:true,payload_source:x.CLIENT_CHANGE_FOLDER};this.handleUpdate(zb);},deleteThread:function(xb){q.isThreadID(xb);ra(this,xb,function(ac){var bc={ids:[ac]};wb(this,'/ajax/mercury/delete_thread.php',bc);}.bind(this));var yb={action_type:o.DELETE_THREAD,action_id:null,thread_id:xb},zb={actions:[yb],from_client:true,payload_source:x.CLIENT_DELETE_THREAD};this.handleUpdate(zb);},deleteMessages:function(xb,yb,zb){da.getServerIDs(yb||[],function(bc){wb(this,'/ajax/mercury/delete_messages.php',{message_ids:bc});}.bind(this));var ac;if(zb){ac={action_type:o.DELETE_THREAD,action_id:null,thread_id:xb};}else ac={action_type:o.DELETE_MESSAGES,action_id:null,thread_id:xb,message_ids:yb};this.handleUpdate({actions:[ac],from_client:true,payload_source:x.CLIENT_DELETE_MESSAGES});},clearChat:function(xb,yb,zb){q.isThreadID(xb);wb(this,'/ajax/chat/settings.php',{clear_history_id:yb});var ac=[{action_type:o.CLEAR_CHAT,action_id:null,thread_id:xb,clear_time:zb}];this.handleUpdate({actions:ac,from_client:true,payload_source:x.CLIENT_CLEAR_CHAT});},sendNewMessage:function(xb,yb){yb=yb||na;if(!xb.client_state||xb.client_state==w.SEND_TO_SERVER)da.getServerIDs(xb.forward_message_ids||[],function(ac){var bc=xb.thread_id,cc=this.tokenizeThreadID(xb.thread_id),dc=cc.type,ec=ja({},xb);ec.forward_message_ids=ac;if((dc=='root'&&cc.value==ec.message_id)||(dc=='user'&&!sa(this,bc))||(xb.thread_id==s.PENDING_THREAD_ID)){ec.client_thread_id=ec.thread_id;ec.thread_id=null;this._sendNewMessageToServer(ec,yb);}else ra(this,ec.thread_id,function(fc){ec.thread_id=fc;this._sendNewMessageToServer(ec);}.bind(this));}.bind(this));if(xb.thread_id!=s.PENDING_THREAD_ID){var zb={actions:[ja({},xb)],from_client:true,payload_source:x.CLIENT_SEND_MESSAGE};this.handleUpdate(zb);}},_sendNewMessageToServer:function(xb,yb){yb=yb||na;this._sentMessagesTimestamp[xb.message_id]=Date.now();wb(this,'/ajax/mercury/send_messages.php',{message_batch:[xb],client:yb});},requestMessageConfirmation:function(xb,yb){yb=yb||na;var zb={},ac={};for(var bc in xb){var cc=sa(this,bc);if(cc){zb[cc]=xb[bc];}else{var dc=xb[bc];for(var ec=0;ec<dc.length;ec++)ac[dc[ec]]=bc;}}var fc=Object.keys(zb),gc=Object.keys(ac);if(fc.length||gc.length)wb(this,'/ajax/mercury/confirm_messages.php',{thread_message_map:zb,local_messages:ac,client:yb});},handleMessageConfirmError:function(xb){var yb=xb.getRequest().getData().thread_message_map,zb=xb.getRequest().getData().local_messages;if(!yb&&!zb)return;var ac=[];for(var bc in yb){var cc=yb[bc];cc.forEach(function(fc){ac.push({action_type:o.SEND_MESSAGE,client_message_id:fc,message_id:fc,client_thread_id:null,thread_id:bc,status:n.UNABLE_TO_CONFIRM});});}for(var dc in zb){var ec=zb[dc];ac.push({action_type:o.SEND_MESSAGE,client_message_id:dc,message_id:dc,client_thread_id:ec,thread_id:null,status:n.UNABLE_TO_CONFIRM});}if(ac.length)this.handleUpdate({actions:ac,payload_source:x.CLIENT_HANDLE_ERROR});},markSeen:function(){var xb=j.convertActionIDToTimestamp(this._lastActionId);wb(this,'/ajax/mercury/mark_seen.php',{seen_timestamp:xb});},handleRoger:function(xb){var yb=xb.tid?this._serverToClientIDs.getResource(xb.tid):('user:'+xb.reader);if(yb){var zb={};zb[yb]={};zb[yb]['fbid:'+xb.reader]=xb.time;this.inform('update-roger',zb);}},handleUpdateWaitForThread:function(xb,yb,zb){zb=zb||na;var ac=this._serverToClientIDs.getResource(yb);if(ac){this.handleUpdate(xb);return;}this._serverToClientIDs.executeOrEnqueue(yb,function(){this._pendingUpdates.push(xb);}.bind(this));if(!this._fetchingThreads[yb]){this._fetchingThreads[yb]=true;wb(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[yb]},client:zb});}},handleUpdate:function(xb){var yb=[];if(xb&&xb.threads)for(var zb=0;zb<xb.threads.length;zb++){if(!xb.threads[zb].snippet_attachments)continue;for(var ac=0;ac<xb.threads[zb].snippet_attachments.length;ac++)if(xb.threads[zb].snippet_attachments[ac].share_xhp){yb.push({i:zb,j:ac,xhp:xb.threads[zb].snippet_attachments[ac].share_xhp});xb.threads[zb].snippet_attachments[ac].share_xhp="HTMLDivElement not shown: object contains circular "+"reference, which was breaking JSON.stringify. "+"Look at MercuryServerRequests.handleUpdate";}}ma.debug('handle_update',{payload:xb,from_client:xb.from_client});for(var bc=0;bc<yb.length;bc++)xb.threads[yb[bc].i].snippet_attachments[yb[bc].j].share_xhp=yb[bc].xhp;for(bc in xb){ia.getForFBID(this._fbid).synchronizeInforms(function(){if(!xb.from_client){ab(this,xb);this.inform('payload-preprocessed',xb);}this.inform('update-thread-ids',this._newlyAddedClientIDs);this._newlyAddedClientIDs={};this.inform('update-participants',xb);this.inform('update-threads',xb);this.inform('update-unread',xb);this.inform('update-threadlist',xb);this.inform('update-messages',xb);this.inform('update-unseen',xb);this.inform('update-typing-state',xb);this.inform('update-roger',xb.roger);this.inform('model-update-completed',null);bb(this);}.bind(this));break;}},_handleSendMessageErrorCommon:function(xb,yb,zb,ac){ma.debug('handle_send_message_error_common',{reliability_error_status:zb,request_error_status:yb});var bc=xb.getData(),cc=bc.message_batch,dc=cc.map(function(fc){return {action_type:o.SEND_MESSAGE,client_message_id:fc.message_id,message_id:fc.message_id,client_thread_id:fc.client_thread_id,thread_id:fc.thread_id,status:yb,error_data:ac};});dc.forEach(function(fc){wa(this,fc,zb);}.bind(this));var ec={actions:dc,payload_source:x.CLIENT_HANDLE_ERROR};this.handleUpdate(ec);},handleSendMessageError:function(xb){var yb=xb.getPayload(),zb=null,ac=null;if(yb&&yb.error_payload){zb=n.UNCONFIRMED;ac='send_error';}else{zb=n.ERROR;ac='request_error'+xa(xb);}var bc=xb.error;if(bc===1404102)h.verboseErrorHandler(xb);var cc=/<.*>/.test(xb.getErrorDescription())?xb.getErrorSummary():xb.getErrorDescription();this._handleSendMessageErrorCommon(xb.getRequest(),zb,ac,{type:r.SERVER,code:xb.getError(),description:cc,is_transient:xb.isTransient()});},handleSendMessageTransportError:function(xb){this._handleSendMessageErrorCommon(xb.getRequest(),n.ERROR,'transport_error'+xa(xb),{type:r.TRANSPORT,code:xb.getError(),is_transient:true});},handleSendMessageTimeout:function(xb){this._handleSendMessageErrorCommon(xb,n.ERROR,'transport_timeout',{type:r.TIMEOUT,is_transient:true});},getLastActionID:function(){return this._lastActionId;}});ja(jb,aa);function kb(xb){return {action_type:o.LOG_MESSAGE,thread_id:xb,message_id:xb,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:ba.UNKNOWN,log_message_type:v.SERVER_ERROR,log_message_data:{}};}function lb(xb){var yb=xb.getData(),zb=yb.request_user_id?yb.request_user_id:k.getID();return jb.getForFBID(zb);}function mb(xb,yb){lb(yb).handleUpdate(xb);}function nb(xb,yb){var zb=xb.client||yb.client;return {client:zb,message_batch:xb.message_batch.concat(yb.message_batch)};}function ob(xb,yb){var zb={};ja(zb,xb.ids);ja(zb,yb.ids);var ac=xb.client||yb.client;return {ids:zb,client:ac};}function pb(xb,yb){return yb;}function qb(xb){var yb=lb(xb.getRequest());yb.handleThreadInfoError(xb);}function rb(xb){var yb=lb(xb.getRequest());yb.handleSendMessageError(xb);}function sb(xb){var yb=lb(xb.getRequest());yb.handleSendMessageTransportError(xb);}function tb(xb){var yb=lb(xb);yb.handleSendMessageTimeout(xb);}function ub(xb){var yb=lb(xb.getRequest());yb.handleMessageConfirmError(xb);}function vb(xb){ha.registerEndpoints({'/ajax/mercury/thread_sync.php':{request_user_id:xb._fbid,mode:ha.IDEMPOTENT,handler:mb},'/ajax/mercury/thread_info.php':{request_user_id:xb._fbid,mode:ha.BATCH_DEFERRED_MULTI,batch_function:cb,handler:mb,error_handler:qb},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:xb._fbid,mode:ha.IMMEDIATE,handler:mb},'/ajax/mercury/change_read_status.php':{request_user_id:xb._fbid,mode:ha.BATCH_SUCCESSIVE,batch_function:ob,handler:mb},'/ajax/mercury/send_messages.php':{request_user_id:xb._fbid,mode:ha.BATCH_SUCCESSIVE,batch_function:nb,batch_size_limit:ea.SEND_BATCH_LIMIT,handler:mb,error_handler:rb,transport_error_handler:sb,timeout:z.sendMessageTimeout,timeout_handler:tb,connection_retries:ea.SEND_CONNECTION_RETRIES},'/ajax/mercury/mark_seen.php':{request_user_id:xb._fbid,mode:ha.BATCH_SUCCESSIVE,batch_function:pb,handler:mb},'/ajax/mercury/confirm_messages.php':{request_user_id:xb._fbid,mode:ha.IMMEDIATE,handler:mb,error_handler:ub},'/ajax/mercury/threadlist_info.php':{request_user_id:xb._fbid,mode:ha.BATCH_SUCCESSIVE_UNIQUE,batch_function:eb,handler:mb},'/ajax/mercury/mark_spam.php':{request_user_id:xb._fbid,mode:ha.IMMEDIATE,handler:mb},'/ajax/mercury/mark_spam_messages.php':{request_user_id:xb._fbid,mode:ha.IMMEDIATE,handler:mb},'/ajax/mercury/unmark_spam.php':{request_user_id:xb._fbid,mode:ha.IMMEDIATE,handler:mb},'/ajax/mercury/unread_threads.php':{request_user_id:xb._fbid,mode:ha.BATCH_SUCCESSIVE_UNIQUE,batch_function:db,handler:mb},'/ajax/chat/settings.php':{request_user_id:xb._fbid,mode:ha.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{request_user_id:xb._fbid,mode:ha.BATCH_SUCCESSIVE,batch_function:gb,handler:mb},'/ajax/mercury/delete_thread.php':{request_user_id:xb._fbid,mode:ha.BATCH_SUCCESSIVE,batch_function:ib,handler:mb},'/ajax/mercury/delete_messages.php':{request_user_id:xb._fbid,mode:ha.IMMEDIATE,handler:mb},'/ajax/mercury/move_thread.php':{request_user_id:xb._fbid,mode:ha.BATCH_SUCCESSIVE,batch_function:hb,handler:mb},'/ajax/mercury/change_mute_thread.php':{request_user_id:xb._fbid,mode:ha.IMMEDIATE,handler:mb}});}function wb(xb,yb,zb,ac){ha.trySend(yb,zb,ac,xb._fbid);}e.exports=jb;});
__d("MercuryParticipants",["CurrentUser","ImageSourceRequest","ImageSourceType","MercuryAssert","MercuryIDs","MercuryParticipantsConstants","MercuryParticipantTypes","PhotoResizeModeConst","ShortProfiles","copyProperties","getObjectValues","tx","MercuryServerRequests"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s=b('MercuryServerRequests').get(),t='fbid:'+g.getID(),u={},v={},w=function(ba){ba=z(ba);if(u[ba.id]){p(u[ba.id],ba);}else u[ba.id]=p({},ba);if(ba.vanity)v[ba.vanity]=ba.id;};function x(ba){j.isEmailParticipantID(ba);var ca=k.tokenize(ba),da=ca.value;return {gender:l.UNKNOWN_GENDER,href:null,id:ba,image_src:l.EMAIL_IMAGE,big_image_src:l.EMAIL_IMAGE,name:da,short_name:da,employee:false,call_promo:false};}function y(ba,ca,da){j.allParticipantIDs(ba);var ea={},fa={};ba.forEach(function(ha){if(u[ha]&&!da){ea[ha]=p({},u[ha]);}else{var ia=k.tokenize(ha);if(ia.type=='fbid'){var ja=ia.value;fa[ha]=ja;}else if(ia.type=='email')ea[ha]=x(ha);}});var ga=q(fa);if(ga.length){o.getMulti(ga,function(ha){for(var ia in fa){var ja=fa[ia],ka=ha[ja];ea[ia]={gender:ka.gender,href:ka.uri,id:ia,image_src:ka.thumbSrc,name:ka.name,short_name:ka.firstName,employee:ka.employee,call_promo:ka.showVideoPromo,type:ka.type,vanity:ka.vanity,is_friend:ka.is_friend,social_snippets:ka.social_snippets};w(ea[ia]);}ca(ea);});}else ca(ea);}function z(ba){var ca=ba.type===m.USER||ba.type===m.FRIEND;if(!ca)return ba;if(!ba.name&&!ba.href&&!ba.vanity){var da="Facebook User";ba.name=da;ba.short_name=da;}return ba;}var aa={user:t,isAuthor:function(ba){return ba===t;},getIDFromVanityOrFBID:function(ba){if(!ba)return;if(v[ba])return v[ba];if(ba.match('^\\d+$'))return aa.getIDForUser(ba);},getNow:function(ba){return u[ba];},get:function(ba,ca){j.isParticipantID(ba);aa.getMulti([ba],function(da){ca(da[ba]);});},getMulti:function(ba,ca,da){return y(ba,ca,false);},getMap:function(ba,ca){var da=[];for(var ea in ba)if(Array.isArray(ba[ea])){da=da.concat(ba[ea]);}else if(ba[ea])da.push(ba[ea]);this.getMulti(da,function(fa){var ga={};for(var ha in ba)if(Array.isArray(ba[ha])){ga[ha]=ba[ha].map(function(ia){return fa[ia];});}else ga[ha]=fa[ba[ha]];ca(ga);});},getBigImageMulti:function(ba,ca){j.allParticipantIDs(ba);var da=l.BIG_IMAGE_SIZE;aa.getMulti(ba,function(ea){var fa={},ga=0,ha=function(la,ma){ga++;fa[la]=ma;if(ga===ba.length)ca(fa);},ia=function(la,ma){u[la].big_image_src=ma.uri;ha(la,ma.uri);};for(var ja in ea){var ka=ea[ja];if(!ka.big_image_src){new h().setFBID(aa.getUserID(ja)).setType(i.PROFILE_PICTURE).setDimensions(da,da).setResizeMode(n.COVER).setCallback(ia.bind(null,ja)).send();}else ha(ka.id,ka.big_image_src);}});},getOrderedBigImageMulti:function(ba,ca){aa.getBigImageMulti(ba,function(da){var ea=ba.map(function(fa){return da[fa];});ca(ea);});},getMultiForceDownload:function(ba,ca){return y(ba,ca,true);},getUserID:function(ba){return k.getUserIDFromParticipantID(ba);},getIDForUser:function(ba){return 'fbid:'+ba;},addParticipants:function(ba){ba.forEach(w);}};s.subscribe('update-participants',function(ba,ca){aa.addParticipants(ca.participants||[]);});e.exports=aa;});
__d("MercuryFolders",["MessagingTag","arrayContains"],function(a,b,c,d,e,f,g,h){var i=[g.INBOX,g.OTHER,g.ACTION_ARCHIVED,g.SPAM],j={getSupportedFolders:function(){return i.concat();},isSupportedFolder:function(k){return h(i,k);},getFromMeta:function(k){var l=k.folder;if(k.is_archived)l=g.ACTION_ARCHIVED;return l;}};e.exports=j;});
__d("MercuryAttachment",["MercuryAttachmentContentType","MercuryAttachmentType","startsWith"],function(a,b,c,d,e,f,g,h,i){var j={getAttachIconClass:function(k){switch(k){case g.PHOTO:return 'MercuryPhotoIcon';case g.VIDEO:return 'MercuryVideoIcon';case g.MUSIC:return 'MercuryMusicIcon';case g.VOICE:return 'MercuryVoiceIcon';case g.TEXT:return 'MercuryTextIcon';case g.MSWORD:return 'MercuryMSWordIcon';case g.MSXLS:return 'MercuryMSXLSIcon';case g.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(k){if(i(k,'image')){return 'MercuryPhotoIcon';}else if(i(k,'video')){return 'MercuryVideoIcon';}else if(i(k,'audio')){return 'MercuryMusicIcon';}else if(i(k,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(k){if(i(k,'image')){return g.PHOTO;}else if(i(k,'video')){return g.VIDEO;}else if(i(k,'audio')){return g.MUSIC;}else if(i(k,'text/plain')){return g.TEXT;}else return g.UNKNOWN;},convertRaw:function(k){var l=[];for(var m=0;m<k.length;m++){var n=k[m];if(n.attach_type===h.PHOTO){l.push(n);}else if(n.filename){var o=j.getAttachTypeByMime(n.filetype),p={};p.attach_type=h.FILE;p.name=n.filename;p.icon_type=o;p.url='';l.push(p);}}return l;},get:function(k){var l=[];if(k.attachments){l=k.attachments;}else if(k.raw_attachments)l=this.convertRaw(k.raw_attachments);if(!(k.attachments&&k.attachments.length>0)&&k.preview_attachments&&k.preview_attachments.length>0)return l.concat(k.preview_attachments);return l;}};e.exports=j;});
__d("MercuryThreads",["TimestampConverter","MercuryFolders","LogHistory","KeyedCallbackManager","MercuryActionTypeConstants","MercuryAssert","MercuryAttachment","MercuryConfig","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercurySingletonMixin","MercuryThreadMode","MessagingTag","MercuryParticipants","ReportState","MercuryServerRequests","MercuryThreadInformer","copyProperties","createObjectFrom","removeFromArray"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa){var ba=i.getInstance('mercury_threads');function ca(pa,qa,ra){var sa=z(qa.participants,true),ta=u.getIDForUser(pa._fbid);ra.forEach(function(ua){if(sa[ua]!==true){qa.participants.push(ua);if(ua===ta)qa.is_subscribed=true;}});}function da(pa,qa,ra){ra.forEach(function(sa){aa(qa.participants,sa);if(sa===u.getIDForUser(pa._fbid))qa.is_subscribed=false;});}function ea(pa,qa){if(pa.participants[0]!=qa){aa(pa.participants,qa);pa.participants.unshift(qa);}}function fa(pa,qa){var ra=qa.body,sa=qa.subject,ta='';if(sa){sa=sa.toLowerCase();if(ra.slice(0,sa.length).toLowerCase()==sa){ta=ra;}else if(ra){ta=sa+' \u00B7 '+ra;}else ta=sa;}else ta=ra;pa.snippet=ta;pa.snippet_has_attachment=qa.has_attachment;if(qa.raw_attachments&&qa.raw_attachments.length>0){var ua=m.convertRaw(qa.raw_attachments);pa.snippet_attachments=ua;}else pa.snippet_attachments=qa.attachments;pa.is_forwarded_snippet=!!qa.forward_count;pa.snippet_sender=qa.author;}function ga(pa,qa,ra){if(!qa)return false;if(!qa.timestamp)return true;var sa=!qa.unread_count;if(ra==sa)return false;qa.unread_count=ra?0:1;pa._threadInformer.updatedThread(qa.thread_id);return true;}function ha(pa,qa){var ra=pa._threads.getAllResources();for(var sa in ra){var ta=ra[sa];if(ta.folder==qa){ta.unread_count=0;pa._threads.setResource(sa,ta);pa._threadInformer.updatedThread(sa);}}}function ia(pa,qa,ra){if(!qa||qa.chat_clear_time===ra)return false;qa.chat_clear_time=ra;pa._threadInformer.reorderedMessages(qa.thread_id);return true;}function ja(pa,qa,ra,sa){if(ra.timestamp)pa._threadInformer.changedThreadReadState(qa.thread_id,sa,ra.timestamp);ga(pa,qa,sa);}function ka(pa,qa,ra,sa){var ta=ra.action_type;if(ta==k.USER_GENERATED_MESSAGE||ta==k.LOG_MESSAGE){ra.is_unread&&qa.unread_count++;qa.message_count++;qa.is_archived=false;}switch(ta){case k.USER_GENERATED_MESSAGE:if(qa.last_read_timestamp>=ra.timestamp)ja(pa,qa,ra,true);ea(qa,ra.author);break;case k.SEND_MESSAGE:var ua=ra.log_message_type;if(ua==q.THREAD_IMAGE)qa.image_src=ra.log_message_data.image?ra.log_message_data.image.preview_url:null;qa.snippet_attachments=ra.attachments;break;case k.LOG_MESSAGE:var ua=ra.log_message_type;if(ua==q.SUBSCRIBE){ca(pa,qa,ra.log_message_data.added_participants);}else if(ua==q.UNSUBSCRIBE){da(pa,qa,ra.log_message_data.removed_participants);}else if(ua==q.THREAD_IMAGE){if(!sa)qa.image_src=ra.log_message_data.image?ra.log_message_data.image.preview_url:null;}else if(ua==q.THREAD_NAME)qa.name=ra.log_message_data.name;break;case k.CHANGE_READ_STATUS:if(ra.timestamp)qa.last_read_timestamp=ra.timestamp;ja(pa,qa,ra,ra.mark_as_read);break;case k.CLEAR_CHAT:ia(pa,qa,ra.clear_time);break;case k.CHANGE_ARCHIVED_STATUS:qa.is_archived=ra.archived;break;case k.CHANGE_FOLDER:qa.folder=ra.new_folder;break;case k.DELETE_MESSAGES:if(sa){qa.snippet='...';qa.snippet_has_attachment=false;qa.snippet_attachments=null;qa.snippet_sender=null;qa.is_forwarded_snippet=false;pa._threadInformer.updatedThread(ra.thread_id);}else if(ra.message_ids)qa.message_count=qa.message_count-ra.message_ids.length;break;case k.CHANGE_MUTE_SETTINGS:if(ra.mute_settings!==undefined){var va=pa._fbid+'@facebook.com';if(qa.mute_settings){if(ra.mute_settings){qa.mute_settings[va]=ra.mute_settings;}else delete qa.mute_settings[va];pa._threadInformer.updatedThread(qa.thread_id);}}break;}if(ra.action_id)qa.last_action_id=g.maxValidActionID(ra.action_id,qa.last_action_id);}function la(pa,qa){var ra=pa._serverRequests.tokenizeThreadID(qa.thread_id);if(ra.type=='group'){ba.error('invalid_new_thread_message',qa);return undefined;}var sa=na(pa,qa.specific_to_list),ta={thread_id:qa.thread_id,last_action_id:qa.action_id,participants:qa.specific_to_list,name:null,snippet:qa.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:qa.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:qa.timestamp_absolute,timestamp_relative:qa.timestamp_relative,timestamp:qa.timestamp,canonical_fbid:ra.type==='user'?ra.value:null,is_canonical_user:ra.type==='user',is_canonical:sa,is_subscribed:true,root_message_threading_id:qa.message_id,folder:t.INBOX,is_archived:false,mode:s.TITAN_ORIGINATED};return ta;}function ma(pa){this._fbid=pa;this._serverRequests=w.getForFBID(this._fbid);this._threadInformer=x.getForFBID(this._fbid);this._threads=new j();oa(this);}y(ma.prototype,{getThreadMetaNow:function(pa){l.isThreadID(pa);return this._threads.getResource(pa);},getThreadMeta:function(pa,qa,ra){var sa=function(ta){qa(ta[pa]);};return this.getMultiThreadMeta([pa],sa,ra);},getMultiThreadMeta:function(pa,qa,ra){l.allThreadID(pa);var sa=this._threads.executeOrEnqueue(pa,qa),ta=this._threads.getUnavailableResources(sa);if(ta.length){var ua=[];for(var va=0;va<ta.length;va++){var wa=ta[va],xa=this._serverRequests.tokenizeThreadID(wa);if(xa.type=='user'){var ya=this.getCanonicalThreadToUser(xa.value,null,ra,true);if(this.isEmptyLocalThread(ya.thread_id))ua.push(ya.thread_id);}else ua.push(wa);}if(ua.length)this._serverRequests.fetchThreadData(ua,ra);}return sa;},unsubscribe:function(pa){this._threads.unsubscribe(pa);},changeThreadReadStatus:function(pa,qa){l.isThreadID(pa);var ra=this._threads.getResource(pa);if(ga(this,ra,qa))this._serverRequests.changeThreadReadStatus(pa,qa,h.getFromMeta(ra));},changeThreadArchivedStatus:function(pa,qa){l.isThreadID(pa);var ra=this._threads.getResource(pa);if(ra.is_archived!=qa){ra.is_archived=qa;this._threadInformer.updatedThread(ra.thread_id);this._serverRequests.changeThreadArchivedStatus(pa,qa);}},markThreadSpam:function(pa){this._serverRequests.markThreadSpam(pa);},unmarkThreadSpam:function(pa){this._serverRequests.unmarkThreadSpam(pa);},updateThreadMuteSetting:function(pa,qa){this._serverRequests.changeMutingOnThread(pa,qa);},changeFolder:function(pa,qa){l.isThreadID(pa);var ra=this._threads.getResource(pa);if(ra&&ra.folder!=qa){ra.folder=qa;this._threadInformer.updatedThread(ra.thread_id);this._serverRequests.changeThreadFolder(pa,qa);}},deleteThread:function(pa){l.isThreadID(pa);this._serverRequests.deleteThread(pa);},updateThreads:function(pa){if(!pa||!pa.length)return;var qa={};pa.forEach(function(ra){qa[ra.thread_id]=ra;});this._threads.addResourcesAndExecute(qa);},updateMetadataByActions:function(pa,qa){if(!pa||!pa.length)return;var ra={},sa={},ta={};for(var ua=0;ua<pa.length;ua++){var va=pa[ua];if(va.is_forward)continue;var wa=va.action_type,xa=va.thread_id;l.isThreadID(xa);var ya=this.getThreadMetaNow(xa);if(wa==k.LOG_MESSAGE&&va.log_message_type==q.SERVER_ERROR)continue;if(!ya&&!va.action_id&&wa==k.USER_GENERATED_MESSAGE){ya=la(this,va);this._threads.setResource(xa,ya);}if(ya){if(wa==k.DELETE_THREAD){ya.message_count=0;this._threadInformer.deletedThread(xa);continue;}var za=!!va.action_id;if(wa==k.LOG_MESSAGE||wa==k.USER_GENERATED_MESSAGE)za=!qa;if(ya.server_timestamp&&va.timestamp<=ya.server_timestamp&&za)continue;if(!ta[xa])ta[xa]=y({},ya);ka(this,ta[xa],va,qa);if(wa==k.USER_GENERATED_MESSAGE)ra[xa]=va;if(wa==k.USER_GENERATED_MESSAGE||wa==k.LOG_MESSAGE||wa==k.SEND_MESSAGE)if(va&&va.timestamp&&(!sa[xa]||va.timestamp>sa[xa].timestamp))sa[xa]=va;}}for(var ab in ta){var bb=ta[ab],cb=ra[ab];if(cb)fa(bb,cb);var db=sa[ab],eb=bb.timestamp;if(db){if(db.timestamp>eb)bb=y(bb,{timestamp_absolute:db.timestamp_absolute,timestamp_relative:db.timestamp_relative,timestamp:db.timestamp});var fb=bb.server_timestamp;if(!qa&&db.timestamp>fb)bb.server_timestamp=db.timestamp;}this._threads.setResource(ab,bb);}},getCanonicalThreadToUser:function(pa,qa,ra,sa){return this.getCanonicalThreadToParticipant('fbid:'+pa,qa,ra,sa);},getCanonicalThreadToParticipant:function(pa,qa,ra,sa){var ta=this.getThreadIDForParticipant(pa),ua=this._threads.getResource(ta);if(typeof ua=='undefined'){ua=this.createNewLocalThread(ta,[u.getIDForUser(this._fbid),pa],qa);!sa&&this._serverRequests.fetchThreadData([ta],ra);}return ua;},getThreadIdForUser:function(pa){return 'user:'+pa;},getThreadIDForParticipant:function(pa){var qa=p.tokenize(pa);return this.getThreadIdForUser(qa.value);},createNewLocalThread:function(pa,qa,ra){var sa=this._threads.getResource(pa);if(!sa){var ta=this._serverRequests.tokenizeThreadID(pa);sa={thread_id:pa,last_action_id:null,participants:qa,name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:ra?ra:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:ta.type==='user'?ta.value:null,is_canonical_user:ta.type=='user',is_canonical:na(this,qa),is_subscribed:true,root_message_threading_id:null,folder:t.INBOX,is_archived:false,mode:s.TITAN_ORIGINATED};this._threads.setResource(pa,sa);}return sa;},addParticipantsToThreadLocally:function(pa,qa){var ra=this._threads.getResource(pa);if(ra){ca(this,ra,qa);this._threadInformer.updatedThread(ra.thread_id);}},getCanonicalUserInThread:function(pa){var qa=this._serverRequests.tokenizeThreadID(pa);return qa.type=='user'?qa.value:null;},getCanonicalGroupInThread:function(pa){var qa=this._serverRequests.tokenizeThreadID(pa);return qa.type=='group'?qa.value:null;},isEmptyLocalThread:function(pa){var qa=this._threads.getResource(pa);if(!qa)return false;var ra=this._serverRequests.tokenizeThreadID(pa);return ra.type=='root'&&!qa.timestamp;},isNewEmptyLocalThread:function(pa){if(!this.isEmptyLocalThread(pa))return false;var qa=this._threads.getResource(pa);return qa.participants&&qa.participants.length===0;},canReply:function(pa){var qa=this._threads.getResource(pa),ra=n.ReadOnlyEmailThreads&&qa.has_email_participant;return qa&&qa.is_subscribed&&qa.mode!=s.OBJECT_ORIGINATED&&!ra&&!qa.read_only&&(qa.recipients_loadable||qa.recipients_loadable===undefined);}});y(ma,r);function na(pa,qa){var ra=qa.filter(function(sa){return sa!=u.getIDForUser(pa._fbid);});return ra.length<=1;}function oa(pa){pa._serverRequests.subscribe('update-threads',function(qa,ra){var sa=(ra.actions||[]).filter(function(wa){return wa.thread_id;});pa.updateThreads(ra.threads);pa.updateMetadataByActions(sa,ra.from_client);(ra.threads||[]).forEach(function(wa){pa._threadInformer.updatedThread(wa.thread_id);});var ta=ra.global_actions||[];for(var ua=0;ua<ta.length;ua++){var va=ta[ua];if(va.action_type==o.MARK_ALL_READ)ha(pa,va.folder);}});}v.registerCallback('mercury-threads',function(){var pa={};pa.threads={};var qa=ma._getInstances();for(var ra in qa)pa.threads[ra]=qa[ra]._threads.dumpResources();return pa;});e.exports=ma;});
__d("MercuryUnreadState",["MercuryFolders","LogHistory","KeyedCallbackManager","MercuryActionTypeConstants","MercuryGlobalActionType","MercurySingletonMixin","MercuryThreadlistConstants","MessagingTag","ReportState","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","arrayContains","copyProperties","createObjectFrom"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){var v=(g.getSupportedFolders()||[]).filter(function(ma){return ma!=n.ACTION_ARCHIVED;}),w='unread_thread_hash',x='unseen_thread_list',y=m.MAX_UNREAD_COUNT,z=h.getInstance('mercury_unread_state');function aa(ma){this._fbid=ma;this._serverRequests=p.getForFBID(this._fbid);this._threadInformer=q.getForFBID(this._fbid);this._threads=r.getForFBID(this._fbid);this._allReadTimestamp={};this._threadReadTimestamp={};this._initialUnreadCount={};this._maxCount={};this._unreadResources={};v.forEach(function(na){this._initialUnreadCount[na]=0;this._maxCount[na]=false;this._unreadResources[na]=new i();}.bind(this));this._serverRequests.subscribe('update-unread',function(na,oa){fa(this,oa);var pa=oa.global_actions||[];for(var qa=0;qa<pa.length;qa++){var ra=pa[qa];if(ra.action_type==k.MARK_ALL_READ)ia(this,ra.folder,ra.timestamp);}}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(na,oa){ka(this,oa);}.bind(this));}t(aa.prototype,{getUnreadCount:function(ma){if(this.exceedsMaxCount(ma)){z.error('unguarded_unread_count_fetch',{});return 0;}return ea(this,ma);},exceedsMaxCount:function(ma){return this._maxCount[ma]||(ea(this,ma)>y);},markFolderAsRead:function(ma){if(this._maxCount[ma]||ea(this,ma)>0)this._serverRequests.markFolderAsRead(ma);}});t(aa,l);function ba(ma,na,oa){ma._unreadResources[na].setResource(w,oa);ma._unreadResources[na].setResource(x,Object.keys(oa));}function ca(ma,na,oa){var pa=ma._unreadResources[na].executeOrEnqueue(w,oa),qa=ma._unreadResources[na].getUnavailableResources(pa);if(qa.length)ma._serverRequests.fetchUnreadThreadIDs(na);}function da(ma,na){return ma._unreadResources[na].getResource(w);}function ea(ma,na){var oa=ma._unreadResources[na].getResource(x);if(oa){return oa.length;}else return ma._initialUnreadCount[na];}function fa(ma,na){var oa;(na.unread_thread_ids||[]).forEach(function(pa){oa=pa.folder;if(!la(oa))return;var qa=ja(ma,pa.thread_ids);ba(ma,oa,u(qa,true));if(qa.length>y)ma._maxCount[oa]=true;ma._threadInformer.updatedUnreadState();});(na.message_counts||[]).forEach(function(pa){if(pa.unread_count===undefined)return;oa=pa.folder;if(pa.unread_count>y){ma._maxCount[oa]=true;ba(ma,oa,{});ma._threadInformer.updatedUnreadState();}else{ma._initialUnreadCount[oa]=pa.unread_count;if(ma._initialUnreadCount[oa]===0)ba(ma,oa,{});ma._threadInformer.updatedUnreadState();}});(na.actions||[]).forEach(function(pa){if(pa.is_forward)return;var qa=j,ra=pa.thread_id?pa.thread_id:pa.server_thread_id;if(pa.action_type==qa.DELETE_THREAD){v.forEach(function(ta){ha(ma,ta,ra);});}else if(pa.action_type==qa.CHANGE_ARCHIVED_STATUS||pa.action_type==qa.CHANGE_FOLDER){var sa=ma._threads.getThreadMetaNow(pa.thread_id);oa=g.getFromMeta(sa);if(la(oa)&&sa.unread_count>0)ga(ma,oa,ra);v.forEach(function(ta){if(ta!=oa)ha(ma,ta,ra);});}else{oa=pa.folder;if(!la(oa))return;if(pa.action_type==qa.CHANGE_READ_STATUS){if(pa.mark_as_read){ha(ma,oa,ra,pa.timestamp);}else ga(ma,oa,ra,pa.timestamp);}else if(pa.action_type==qa.USER_GENERATED_MESSAGE||pa.action_type==qa.LOG_MESSAGE)if(pa.is_unread)ga(ma,oa,ra,pa.timestamp);}});}function ga(ma,na,oa,pa){if(ma._maxCount[na])return;ca(ma,na,function(qa){var ra=ma._allReadTimestamp[na]||0,sa=ma._threadReadTimestamp[oa]||0,ta=pa||Number.POSITIVE_INFINITY;if(ta>=ra&&ta>=sa&&!qa[oa]){qa[oa]=pa||0;ba(ma,na,qa);ma._threadInformer.updatedUnreadState();}});}function ha(ma,na,oa,pa){if(ma._maxCount[na])return;ca(ma,na,function(qa){if(pa){var ra=ma._threadReadTimestamp[oa];if(!ra||ra<pa)ma._threadReadTimestamp[oa]=pa;}var sa=qa[oa];if(pa&&typeof sa=='number'&&pa<sa)return;if(oa in qa){delete qa[oa];ba(ma,na,qa);ma._threadInformer.updatedUnreadState();}});}function ia(ma,na,oa){ma._maxCount[na]=false;ba(ma,na,{});ma._allReadTimestamp[na]=Math.max(ma._allReadTimestamp[na]||0,oa||0);ma._threadInformer.updatedUnreadState();}function ja(ma,na){return na.map(ma._serverRequests.convertThreadIDIfAvailable.bind(ma._serverRequests));}function ka(ma,na){v.forEach(function(oa){var pa=da(ma,oa);if(!pa)return;for(var qa in na){var ra=na[qa];if(pa[qa]){pa[ra]=pa[qa];delete pa[qa];}}ba(ma,oa,pa);});}function la(ma){return s(v,ma);}o.registerCallback('mercury-unread-state',function(){var ma={};ma.unread={};ma.unread_max_count={};var na=aa._getInstances();for(var oa in na){ma.unread[oa]={};ma.unread_max_count[oa]={};v.forEach(function(pa){ma.unread[oa][pa]=t({},da(na[oa],pa));ma.unread_max_count[oa][pa]=na[oa]._maxCount[pa];});}return ma;});e.exports=aa;});